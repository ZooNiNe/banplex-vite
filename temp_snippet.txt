
    return headerMetaHTML + mainPaymentSection + metaDetailsHTML + invoiceItemsHTML + paymentHistoryHTML + attachmentsHTML;
}

function _createCommentsSectionHTML(parentId, parentType) {
    try {
        const items = (appState.comments || [])
            .filter(c => c.parentId === parentId && c.parentType === parentType && !c.isDeleted)
            .sort((a, b) => _getJSDate(a.createdAt) - _getJSDate(b.createdAt));

        const listHTML = items.length > 0 ? items.map(c => {
            const isCurrentUser = appState.currentUser && appState.currentUser.uid === c.userId;
            const when = _getJSDate(c.createdAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const canDelete = !!appState.currentUser && (isCurrentUser || appState.userRole === 'Owner');
            const safeText = String(c.content || '').replace(/</g, '&lt;'); // pre-wrap akan menangani \n
            const initials = (c.userName || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

            return `
                <div class="comment-item ${isCurrentUser ? 'is-current-user' : ''}" data-id="${c.id}">
                    <div class="comment-avatar">${initials}</div>
                    <div class="comment-bubble">
                        <div class="comment-meta">
                            <strong class="comment-user">${c.userName || 'Pengguna'}</strong>
                            ${canDelete ? `<button class="btn-icon btn-icon-danger" data-action="delete-comment" data-id="${c.id}" title="Hapus"><span class="material-symbols-outlined">delete</span></button>` : ''}
                        </div>
                        <div class="comment-text">${safeText}</div>
                        <div class="comment-date">${when}</div>
                    </div>
                </div>
